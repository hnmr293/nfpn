import torch

# 00_0011_1111
HF10_MAX = 0.5 * (1+0.5+0.25+0.125)

# 00_0000_0000
HF10_MIN = 2 ** (-15)


def to_hf10(data: torch.Tensor):
    data = data.to(dtype=torch.float16)
    
    assert (data.abs() <= HF10_MAX).all().item(), f'max value = {data.abs().max().item()}'
    
    # fp16: sEEE_EEff_ffff_ffff
    #
    # hf10 type-a: sE_EEff_ffff  where EEE != 000
    #       mantissa = E-12 = -5..-11
    # hf10 type-b: s0_00ff_f0GG
    #       mantissa = G-15 = -12..-15
    # hf10 type-c: s0_00ff_f1HH
    #       mantissa = H-4 = -1..-4
    #
    # * significant bits
    #       00_0000 = 1 + 0
    #       10_0000 = 1 + 0.5
    #       01_0000 = 1 + 0.25
    #       00_1000 = 1 + 0.125
    #       00_0100 = 1 + 0.0625
    #       00_0010 = 1 + 0.03125
    #       00_0001 = 1 + 0.015625
    #
    
    idata = data.view(dtype=torch.int16).view(size=(-1,))
    assert idata.numel() % 4 == 0
    
    mask_s = 0b1000_0000_0000_0000
    mask_e = 0b0111_1100_0000_0000
    mask_f = 0b0000_0011_1111_1111
    
    # sign
    s = ((idata & mask_s) >> 12).to(dtype=torch.uint8) & 0b1000
    
    # exponential
    e = ((idata & mask_e) >> 10) - 15
    e = e.clamp(-15, -1)
    
    E_mask = torch.logical_and(-11 <= e, e <= -5)
    
    E = (e + 12).to(dtype=torch.int8).view(dtype=torch.uint8)
    E[~E_mask] = 0
    E += s
    
    E1 = (E & 0b1100) >> 2
    E2 = E & 0b0011
    
    E1 = E1.view((-1,4))
    E1.bitwise_left_shift_(torch.tensor([6, 4, 2, 0]))
    E1 = E1.sum(dim=-1, dtype=torch.uint8)
    
    E2 <<= 6
    
    # significants
    f = idata & mask_f
    F = (f >> 4).to(dtype=torch.uint8)
    
    ## significants of type-b
    G_mask = e < -11
    Ge = (e + 15).to(dtype=torch.int8).view(dtype=torch.uint8)
    Ge = Ge.clamp(0, 3)
    F[G_mask] = (F[G_mask] & 0b11_1000) + Ge[G_mask]
    
    ## significants of type-c
    H_mask = -5 < e
    He = (e + 4).to(dtype=torch.int8).view(dtype=torch.uint8)
    He = He.clamp(0, 3)
    F[H_mask] = (F[H_mask] & 0b11_1000) + He[H_mask] + 0b100
    
    F.add_(E2)
    
    return E1, F

def hf10_to_fp16_2(exp: torch.Tensor, frac: torch.Tensor):
    assert exp.dtype == torch.uint8
    assert frac.dtype == torch.uint8
    assert exp.ndim == 1
    assert frac.ndim == 1
    assert exp.size(0) * 4 == frac.size(0)
    
    FP16 = torch.zeros(frac.shape, dtype=torch.int16, device=frac.device)
    
    exp = exp[..., None].repeat_interleave(4)
    exp.view((-1,4)).bitwise_right_shift_(torch.tensor([6, 4, 2, 0], device=exp.device))
    exp.bitwise_and_(0b11)
    
    # sign
    FP16[:] = exp & 0b10
    FP16 <<= 14
    
    # exponential
    exp_e = (((exp & 1) << 2) + (frac >> 6)).to(dtype=torch.int16)
    exp_gh = (frac & 0b11).to(dtype=torch.int16)
    
    E_mask = exp_e != 0
    G_mask = torch.logical_and(exp_e == 0, (frac & 0b100) == 0)
    H_mask = torch.logical_and(exp_e == 0, (frac & 0b100) == 4)
    
    FP16 += (
        ## type-a
        E_mask * (exp_e + 3) +
        #                 ^ EEE - 12 = -15 + a <=> a = EEE + 3
        ## type-b
        G_mask * exp_gh +
        #              ^ GG - 15 = -15 + a <=> a = GG
        ## type-c
        H_mask * (exp_gh + 11)
        #                  ^ HH - 4 = -15 + a <=> a = HH + 11
    ) << 10
    
    # significants
    FP16 += (
        ## type-a
        E_mask * (frac & 0b111_111) +
        ## type-b and type-c
        (G_mask + H_mask) * (frac & 0b111_000)
    ).to(dtype=torch.int16) << 4  # TODO pad random value?
    
    return FP16.view(dtype=torch.float16)


HF10_TO_FP16 = torch.tensor([
    0b0_00000_0000000000, 0b0_00001_0000000000, 0b0_00010_0000000000, 0b0_00011_0000000000, 0b0_01011_0000000000, 0b0_01100_0000000000, 0b0_01101_0000000000, 0b0_01110_0000000000, 0b0_00000_0010000000, 0b0_00001_0010000000, 0b0_00010_0010000000, 0b0_00011_0010000000, 0b0_01011_0010000000, 0b0_01100_0010000000, 0b0_01101_0010000000, 0b0_01110_0010000000, 
    0b0_00000_0100000000, 0b0_00001_0100000000, 0b0_00010_0100000000, 0b0_00011_0100000000, 0b0_01011_0100000000, 0b0_01100_0100000000, 0b0_01101_0100000000, 0b0_01110_0100000000, 0b0_00000_0110000000, 0b0_00001_0110000000, 0b0_00010_0110000000, 0b0_00011_0110000000, 0b0_01011_0110000000, 0b0_01100_0110000000, 0b0_01101_0110000000, 0b0_01110_0110000000, 
    0b0_00000_1000000000, 0b0_00001_1000000000, 0b0_00010_1000000000, 0b0_00011_1000000000, 0b0_01011_1000000000, 0b0_01100_1000000000, 0b0_01101_1000000000, 0b0_01110_1000000000, 0b0_00000_1010000000, 0b0_00001_1010000000, 0b0_00010_1010000000, 0b0_00011_1010000000, 0b0_01011_1010000000, 0b0_01100_1010000000, 0b0_01101_1010000000, 0b0_01110_1010000000, 
    0b0_00000_1100000000, 0b0_00001_1100000000, 0b0_00010_1100000000, 0b0_00011_1100000000, 0b0_01011_1100000000, 0b0_01100_1100000000, 0b0_01101_1100000000, 0b0_01110_1100000000, 0b0_00000_1110000000, 0b0_00001_1110000000, 0b0_00010_1110000000, 0b0_00011_1110000000, 0b0_01011_1110000000, 0b0_01100_1110000000, 0b0_01101_1110000000, 0b0_01110_1110000000, 
    0b0_00100_0000000000, 0b0_00100_0000010000, 0b0_00100_0000100000, 0b0_00100_0000110000, 0b0_00100_0001000000, 0b0_00100_0001010000, 0b0_00100_0001100000, 0b0_00100_0001110000, 0b0_00100_0010000000, 0b0_00100_0010010000, 0b0_00100_0010100000, 0b0_00100_0010110000, 0b0_00100_0011000000, 0b0_00100_0011010000, 0b0_00100_0011100000, 0b0_00100_0011110000, 
    0b0_00100_0100000000, 0b0_00100_0100010000, 0b0_00100_0100100000, 0b0_00100_0100110000, 0b0_00100_0101000000, 0b0_00100_0101010000, 0b0_00100_0101100000, 0b0_00100_0101110000, 0b0_00100_0110000000, 0b0_00100_0110010000, 0b0_00100_0110100000, 0b0_00100_0110110000, 0b0_00100_0111000000, 0b0_00100_0111010000, 0b0_00100_0111100000, 0b0_00100_0111110000, 
    0b0_00100_1000000000, 0b0_00100_1000010000, 0b0_00100_1000100000, 0b0_00100_1000110000, 0b0_00100_1001000000, 0b0_00100_1001010000, 0b0_00100_1001100000, 0b0_00100_1001110000, 0b0_00100_1010000000, 0b0_00100_1010010000, 0b0_00100_1010100000, 0b0_00100_1010110000, 0b0_00100_1011000000, 0b0_00100_1011010000, 0b0_00100_1011100000, 0b0_00100_1011110000, 
    0b0_00100_1100000000, 0b0_00100_1100010000, 0b0_00100_1100100000, 0b0_00100_1100110000, 0b0_00100_1101000000, 0b0_00100_1101010000, 0b0_00100_1101100000, 0b0_00100_1101110000, 0b0_00100_1110000000, 0b0_00100_1110010000, 0b0_00100_1110100000, 0b0_00100_1110110000, 0b0_00100_1111000000, 0b0_00100_1111010000, 0b0_00100_1111100000, 0b0_00100_1111110000, 
    0b0_00101_0000000000, 0b0_00101_0000010000, 0b0_00101_0000100000, 0b0_00101_0000110000, 0b0_00101_0001000000, 0b0_00101_0001010000, 0b0_00101_0001100000, 0b0_00101_0001110000, 0b0_00101_0010000000, 0b0_00101_0010010000, 0b0_00101_0010100000, 0b0_00101_0010110000, 0b0_00101_0011000000, 0b0_00101_0011010000, 0b0_00101_0011100000, 0b0_00101_0011110000, 
    0b0_00101_0100000000, 0b0_00101_0100010000, 0b0_00101_0100100000, 0b0_00101_0100110000, 0b0_00101_0101000000, 0b0_00101_0101010000, 0b0_00101_0101100000, 0b0_00101_0101110000, 0b0_00101_0110000000, 0b0_00101_0110010000, 0b0_00101_0110100000, 0b0_00101_0110110000, 0b0_00101_0111000000, 0b0_00101_0111010000, 0b0_00101_0111100000, 0b0_00101_0111110000, 
    0b0_00101_1000000000, 0b0_00101_1000010000, 0b0_00101_1000100000, 0b0_00101_1000110000, 0b0_00101_1001000000, 0b0_00101_1001010000, 0b0_00101_1001100000, 0b0_00101_1001110000, 0b0_00101_1010000000, 0b0_00101_1010010000, 0b0_00101_1010100000, 0b0_00101_1010110000, 0b0_00101_1011000000, 0b0_00101_1011010000, 0b0_00101_1011100000, 0b0_00101_1011110000, 
    0b0_00101_1100000000, 0b0_00101_1100010000, 0b0_00101_1100100000, 0b0_00101_1100110000, 0b0_00101_1101000000, 0b0_00101_1101010000, 0b0_00101_1101100000, 0b0_00101_1101110000, 0b0_00101_1110000000, 0b0_00101_1110010000, 0b0_00101_1110100000, 0b0_00101_1110110000, 0b0_00101_1111000000, 0b0_00101_1111010000, 0b0_00101_1111100000, 0b0_00101_1111110000, 
    0b0_00110_0000000000, 0b0_00110_0000010000, 0b0_00110_0000100000, 0b0_00110_0000110000, 0b0_00110_0001000000, 0b0_00110_0001010000, 0b0_00110_0001100000, 0b0_00110_0001110000, 0b0_00110_0010000000, 0b0_00110_0010010000, 0b0_00110_0010100000, 0b0_00110_0010110000, 0b0_00110_0011000000, 0b0_00110_0011010000, 0b0_00110_0011100000, 0b0_00110_0011110000, 
    0b0_00110_0100000000, 0b0_00110_0100010000, 0b0_00110_0100100000, 0b0_00110_0100110000, 0b0_00110_0101000000, 0b0_00110_0101010000, 0b0_00110_0101100000, 0b0_00110_0101110000, 0b0_00110_0110000000, 0b0_00110_0110010000, 0b0_00110_0110100000, 0b0_00110_0110110000, 0b0_00110_0111000000, 0b0_00110_0111010000, 0b0_00110_0111100000, 0b0_00110_0111110000, 
    0b0_00110_1000000000, 0b0_00110_1000010000, 0b0_00110_1000100000, 0b0_00110_1000110000, 0b0_00110_1001000000, 0b0_00110_1001010000, 0b0_00110_1001100000, 0b0_00110_1001110000, 0b0_00110_1010000000, 0b0_00110_1010010000, 0b0_00110_1010100000, 0b0_00110_1010110000, 0b0_00110_1011000000, 0b0_00110_1011010000, 0b0_00110_1011100000, 0b0_00110_1011110000, 
    0b0_00110_1100000000, 0b0_00110_1100010000, 0b0_00110_1100100000, 0b0_00110_1100110000, 0b0_00110_1101000000, 0b0_00110_1101010000, 0b0_00110_1101100000, 0b0_00110_1101110000, 0b0_00110_1110000000, 0b0_00110_1110010000, 0b0_00110_1110100000, 0b0_00110_1110110000, 0b0_00110_1111000000, 0b0_00110_1111010000, 0b0_00110_1111100000, 0b0_00110_1111110000, 
    0b0_00111_0000000000, 0b0_00111_0000010000, 0b0_00111_0000100000, 0b0_00111_0000110000, 0b0_00111_0001000000, 0b0_00111_0001010000, 0b0_00111_0001100000, 0b0_00111_0001110000, 0b0_00111_0010000000, 0b0_00111_0010010000, 0b0_00111_0010100000, 0b0_00111_0010110000, 0b0_00111_0011000000, 0b0_00111_0011010000, 0b0_00111_0011100000, 0b0_00111_0011110000, 
    0b0_00111_0100000000, 0b0_00111_0100010000, 0b0_00111_0100100000, 0b0_00111_0100110000, 0b0_00111_0101000000, 0b0_00111_0101010000, 0b0_00111_0101100000, 0b0_00111_0101110000, 0b0_00111_0110000000, 0b0_00111_0110010000, 0b0_00111_0110100000, 0b0_00111_0110110000, 0b0_00111_0111000000, 0b0_00111_0111010000, 0b0_00111_0111100000, 0b0_00111_0111110000, 
    0b0_00111_1000000000, 0b0_00111_1000010000, 0b0_00111_1000100000, 0b0_00111_1000110000, 0b0_00111_1001000000, 0b0_00111_1001010000, 0b0_00111_1001100000, 0b0_00111_1001110000, 0b0_00111_1010000000, 0b0_00111_1010010000, 0b0_00111_1010100000, 0b0_00111_1010110000, 0b0_00111_1011000000, 0b0_00111_1011010000, 0b0_00111_1011100000, 0b0_00111_1011110000, 
    0b0_00111_1100000000, 0b0_00111_1100010000, 0b0_00111_1100100000, 0b0_00111_1100110000, 0b0_00111_1101000000, 0b0_00111_1101010000, 0b0_00111_1101100000, 0b0_00111_1101110000, 0b0_00111_1110000000, 0b0_00111_1110010000, 0b0_00111_1110100000, 0b0_00111_1110110000, 0b0_00111_1111000000, 0b0_00111_1111010000, 0b0_00111_1111100000, 0b0_00111_1111110000, 
    0b0_01000_0000000000, 0b0_01000_0000010000, 0b0_01000_0000100000, 0b0_01000_0000110000, 0b0_01000_0001000000, 0b0_01000_0001010000, 0b0_01000_0001100000, 0b0_01000_0001110000, 0b0_01000_0010000000, 0b0_01000_0010010000, 0b0_01000_0010100000, 0b0_01000_0010110000, 0b0_01000_0011000000, 0b0_01000_0011010000, 0b0_01000_0011100000, 0b0_01000_0011110000, 
    0b0_01000_0100000000, 0b0_01000_0100010000, 0b0_01000_0100100000, 0b0_01000_0100110000, 0b0_01000_0101000000, 0b0_01000_0101010000, 0b0_01000_0101100000, 0b0_01000_0101110000, 0b0_01000_0110000000, 0b0_01000_0110010000, 0b0_01000_0110100000, 0b0_01000_0110110000, 0b0_01000_0111000000, 0b0_01000_0111010000, 0b0_01000_0111100000, 0b0_01000_0111110000, 
    0b0_01000_1000000000, 0b0_01000_1000010000, 0b0_01000_1000100000, 0b0_01000_1000110000, 0b0_01000_1001000000, 0b0_01000_1001010000, 0b0_01000_1001100000, 0b0_01000_1001110000, 0b0_01000_1010000000, 0b0_01000_1010010000, 0b0_01000_1010100000, 0b0_01000_1010110000, 0b0_01000_1011000000, 0b0_01000_1011010000, 0b0_01000_1011100000, 0b0_01000_1011110000, 
    0b0_01000_1100000000, 0b0_01000_1100010000, 0b0_01000_1100100000, 0b0_01000_1100110000, 0b0_01000_1101000000, 0b0_01000_1101010000, 0b0_01000_1101100000, 0b0_01000_1101110000, 0b0_01000_1110000000, 0b0_01000_1110010000, 0b0_01000_1110100000, 0b0_01000_1110110000, 0b0_01000_1111000000, 0b0_01000_1111010000, 0b0_01000_1111100000, 0b0_01000_1111110000, 
    0b0_01001_0000000000, 0b0_01001_0000010000, 0b0_01001_0000100000, 0b0_01001_0000110000, 0b0_01001_0001000000, 0b0_01001_0001010000, 0b0_01001_0001100000, 0b0_01001_0001110000, 0b0_01001_0010000000, 0b0_01001_0010010000, 0b0_01001_0010100000, 0b0_01001_0010110000, 0b0_01001_0011000000, 0b0_01001_0011010000, 0b0_01001_0011100000, 0b0_01001_0011110000, 
    0b0_01001_0100000000, 0b0_01001_0100010000, 0b0_01001_0100100000, 0b0_01001_0100110000, 0b0_01001_0101000000, 0b0_01001_0101010000, 0b0_01001_0101100000, 0b0_01001_0101110000, 0b0_01001_0110000000, 0b0_01001_0110010000, 0b0_01001_0110100000, 0b0_01001_0110110000, 0b0_01001_0111000000, 0b0_01001_0111010000, 0b0_01001_0111100000, 0b0_01001_0111110000, 
    0b0_01001_1000000000, 0b0_01001_1000010000, 0b0_01001_1000100000, 0b0_01001_1000110000, 0b0_01001_1001000000, 0b0_01001_1001010000, 0b0_01001_1001100000, 0b0_01001_1001110000, 0b0_01001_1010000000, 0b0_01001_1010010000, 0b0_01001_1010100000, 0b0_01001_1010110000, 0b0_01001_1011000000, 0b0_01001_1011010000, 0b0_01001_1011100000, 0b0_01001_1011110000, 
    0b0_01001_1100000000, 0b0_01001_1100010000, 0b0_01001_1100100000, 0b0_01001_1100110000, 0b0_01001_1101000000, 0b0_01001_1101010000, 0b0_01001_1101100000, 0b0_01001_1101110000, 0b0_01001_1110000000, 0b0_01001_1110010000, 0b0_01001_1110100000, 0b0_01001_1110110000, 0b0_01001_1111000000, 0b0_01001_1111010000, 0b0_01001_1111100000, 0b0_01001_1111110000, 
    0b0_01010_0000000000, 0b0_01010_0000010000, 0b0_01010_0000100000, 0b0_01010_0000110000, 0b0_01010_0001000000, 0b0_01010_0001010000, 0b0_01010_0001100000, 0b0_01010_0001110000, 0b0_01010_0010000000, 0b0_01010_0010010000, 0b0_01010_0010100000, 0b0_01010_0010110000, 0b0_01010_0011000000, 0b0_01010_0011010000, 0b0_01010_0011100000, 0b0_01010_0011110000, 
    0b0_01010_0100000000, 0b0_01010_0100010000, 0b0_01010_0100100000, 0b0_01010_0100110000, 0b0_01010_0101000000, 0b0_01010_0101010000, 0b0_01010_0101100000, 0b0_01010_0101110000, 0b0_01010_0110000000, 0b0_01010_0110010000, 0b0_01010_0110100000, 0b0_01010_0110110000, 0b0_01010_0111000000, 0b0_01010_0111010000, 0b0_01010_0111100000, 0b0_01010_0111110000, 
    0b0_01010_1000000000, 0b0_01010_1000010000, 0b0_01010_1000100000, 0b0_01010_1000110000, 0b0_01010_1001000000, 0b0_01010_1001010000, 0b0_01010_1001100000, 0b0_01010_1001110000, 0b0_01010_1010000000, 0b0_01010_1010010000, 0b0_01010_1010100000, 0b0_01010_1010110000, 0b0_01010_1011000000, 0b0_01010_1011010000, 0b0_01010_1011100000, 0b0_01010_1011110000, 
    0b0_01010_1100000000, 0b0_01010_1100010000, 0b0_01010_1100100000, 0b0_01010_1100110000, 0b0_01010_1101000000, 0b0_01010_1101010000, 0b0_01010_1101100000, 0b0_01010_1101110000, 0b0_01010_1110000000, 0b0_01010_1110010000, 0b0_01010_1110100000, 0b0_01010_1110110000, 0b0_01010_1111000000, 0b0_01010_1111010000, 0b0_01010_1111100000, 0b0_01010_1111110000, 
    0b0_00000_0000000000, 0b0_00001_0000000000, 0b0_00010_0000000000, 0b0_00011_0000000000, 0b0_01011_0000000000, 0b0_01100_0000000000, 0b0_01101_0000000000, 0b0_01110_0000000000, 0b0_00000_0010000000, 0b0_00001_0010000000, 0b0_00010_0010000000, 0b0_00011_0010000000, 0b0_01011_0010000000, 0b0_01100_0010000000, 0b0_01101_0010000000, 0b0_01110_0010000000, 
    0b0_00000_0100000000, 0b0_00001_0100000000, 0b0_00010_0100000000, 0b0_00011_0100000000, 0b0_01011_0100000000, 0b0_01100_0100000000, 0b0_01101_0100000000, 0b0_01110_0100000000, 0b0_00000_0110000000, 0b0_00001_0110000000, 0b0_00010_0110000000, 0b0_00011_0110000000, 0b0_01011_0110000000, 0b0_01100_0110000000, 0b0_01101_0110000000, 0b0_01110_0110000000, 
    0b0_00000_1000000000, 0b0_00001_1000000000, 0b0_00010_1000000000, 0b0_00011_1000000000, 0b0_01011_1000000000, 0b0_01100_1000000000, 0b0_01101_1000000000, 0b0_01110_1000000000, 0b0_00000_1010000000, 0b0_00001_1010000000, 0b0_00010_1010000000, 0b0_00011_1010000000, 0b0_01011_1010000000, 0b0_01100_1010000000, 0b0_01101_1010000000, 0b0_01110_1010000000, 
    0b0_00000_1100000000, 0b0_00001_1100000000, 0b0_00010_1100000000, 0b0_00011_1100000000, 0b0_01011_1100000000, 0b0_01100_1100000000, 0b0_01101_1100000000, 0b0_01110_1100000000, 0b0_00000_1110000000, 0b0_00001_1110000000, 0b0_00010_1110000000, 0b0_00011_1110000000, 0b0_01011_1110000000, 0b0_01100_1110000000, 0b0_01101_1110000000, 0b0_01110_1110000000, 
    0b0_00100_0000000000, 0b0_00100_0000010000, 0b0_00100_0000100000, 0b0_00100_0000110000, 0b0_00100_0001000000, 0b0_00100_0001010000, 0b0_00100_0001100000, 0b0_00100_0001110000, 0b0_00100_0010000000, 0b0_00100_0010010000, 0b0_00100_0010100000, 0b0_00100_0010110000, 0b0_00100_0011000000, 0b0_00100_0011010000, 0b0_00100_0011100000, 0b0_00100_0011110000, 
    0b0_00100_0100000000, 0b0_00100_0100010000, 0b0_00100_0100100000, 0b0_00100_0100110000, 0b0_00100_0101000000, 0b0_00100_0101010000, 0b0_00100_0101100000, 0b0_00100_0101110000, 0b0_00100_0110000000, 0b0_00100_0110010000, 0b0_00100_0110100000, 0b0_00100_0110110000, 0b0_00100_0111000000, 0b0_00100_0111010000, 0b0_00100_0111100000, 0b0_00100_0111110000, 
    0b0_00100_1000000000, 0b0_00100_1000010000, 0b0_00100_1000100000, 0b0_00100_1000110000, 0b0_00100_1001000000, 0b0_00100_1001010000, 0b0_00100_1001100000, 0b0_00100_1001110000, 0b0_00100_1010000000, 0b0_00100_1010010000, 0b0_00100_1010100000, 0b0_00100_1010110000, 0b0_00100_1011000000, 0b0_00100_1011010000, 0b0_00100_1011100000, 0b0_00100_1011110000, 
    0b0_00100_1100000000, 0b0_00100_1100010000, 0b0_00100_1100100000, 0b0_00100_1100110000, 0b0_00100_1101000000, 0b0_00100_1101010000, 0b0_00100_1101100000, 0b0_00100_1101110000, 0b0_00100_1110000000, 0b0_00100_1110010000, 0b0_00100_1110100000, 0b0_00100_1110110000, 0b0_00100_1111000000, 0b0_00100_1111010000, 0b0_00100_1111100000, 0b0_00100_1111110000, 
    0b0_00101_0000000000, 0b0_00101_0000010000, 0b0_00101_0000100000, 0b0_00101_0000110000, 0b0_00101_0001000000, 0b0_00101_0001010000, 0b0_00101_0001100000, 0b0_00101_0001110000, 0b0_00101_0010000000, 0b0_00101_0010010000, 0b0_00101_0010100000, 0b0_00101_0010110000, 0b0_00101_0011000000, 0b0_00101_0011010000, 0b0_00101_0011100000, 0b0_00101_0011110000, 
    0b0_00101_0100000000, 0b0_00101_0100010000, 0b0_00101_0100100000, 0b0_00101_0100110000, 0b0_00101_0101000000, 0b0_00101_0101010000, 0b0_00101_0101100000, 0b0_00101_0101110000, 0b0_00101_0110000000, 0b0_00101_0110010000, 0b0_00101_0110100000, 0b0_00101_0110110000, 0b0_00101_0111000000, 0b0_00101_0111010000, 0b0_00101_0111100000, 0b0_00101_0111110000, 
    0b0_00101_1000000000, 0b0_00101_1000010000, 0b0_00101_1000100000, 0b0_00101_1000110000, 0b0_00101_1001000000, 0b0_00101_1001010000, 0b0_00101_1001100000, 0b0_00101_1001110000, 0b0_00101_1010000000, 0b0_00101_1010010000, 0b0_00101_1010100000, 0b0_00101_1010110000, 0b0_00101_1011000000, 0b0_00101_1011010000, 0b0_00101_1011100000, 0b0_00101_1011110000, 
    0b0_00101_1100000000, 0b0_00101_1100010000, 0b0_00101_1100100000, 0b0_00101_1100110000, 0b0_00101_1101000000, 0b0_00101_1101010000, 0b0_00101_1101100000, 0b0_00101_1101110000, 0b0_00101_1110000000, 0b0_00101_1110010000, 0b0_00101_1110100000, 0b0_00101_1110110000, 0b0_00101_1111000000, 0b0_00101_1111010000, 0b0_00101_1111100000, 0b0_00101_1111110000, 
    0b0_00110_0000000000, 0b0_00110_0000010000, 0b0_00110_0000100000, 0b0_00110_0000110000, 0b0_00110_0001000000, 0b0_00110_0001010000, 0b0_00110_0001100000, 0b0_00110_0001110000, 0b0_00110_0010000000, 0b0_00110_0010010000, 0b0_00110_0010100000, 0b0_00110_0010110000, 0b0_00110_0011000000, 0b0_00110_0011010000, 0b0_00110_0011100000, 0b0_00110_0011110000, 
    0b0_00110_0100000000, 0b0_00110_0100010000, 0b0_00110_0100100000, 0b0_00110_0100110000, 0b0_00110_0101000000, 0b0_00110_0101010000, 0b0_00110_0101100000, 0b0_00110_0101110000, 0b0_00110_0110000000, 0b0_00110_0110010000, 0b0_00110_0110100000, 0b0_00110_0110110000, 0b0_00110_0111000000, 0b0_00110_0111010000, 0b0_00110_0111100000, 0b0_00110_0111110000, 
    0b0_00110_1000000000, 0b0_00110_1000010000, 0b0_00110_1000100000, 0b0_00110_1000110000, 0b0_00110_1001000000, 0b0_00110_1001010000, 0b0_00110_1001100000, 0b0_00110_1001110000, 0b0_00110_1010000000, 0b0_00110_1010010000, 0b0_00110_1010100000, 0b0_00110_1010110000, 0b0_00110_1011000000, 0b0_00110_1011010000, 0b0_00110_1011100000, 0b0_00110_1011110000, 
    0b0_00110_1100000000, 0b0_00110_1100010000, 0b0_00110_1100100000, 0b0_00110_1100110000, 0b0_00110_1101000000, 0b0_00110_1101010000, 0b0_00110_1101100000, 0b0_00110_1101110000, 0b0_00110_1110000000, 0b0_00110_1110010000, 0b0_00110_1110100000, 0b0_00110_1110110000, 0b0_00110_1111000000, 0b0_00110_1111010000, 0b0_00110_1111100000, 0b0_00110_1111110000, 
    0b0_00111_0000000000, 0b0_00111_0000010000, 0b0_00111_0000100000, 0b0_00111_0000110000, 0b0_00111_0001000000, 0b0_00111_0001010000, 0b0_00111_0001100000, 0b0_00111_0001110000, 0b0_00111_0010000000, 0b0_00111_0010010000, 0b0_00111_0010100000, 0b0_00111_0010110000, 0b0_00111_0011000000, 0b0_00111_0011010000, 0b0_00111_0011100000, 0b0_00111_0011110000, 
    0b0_00111_0100000000, 0b0_00111_0100010000, 0b0_00111_0100100000, 0b0_00111_0100110000, 0b0_00111_0101000000, 0b0_00111_0101010000, 0b0_00111_0101100000, 0b0_00111_0101110000, 0b0_00111_0110000000, 0b0_00111_0110010000, 0b0_00111_0110100000, 0b0_00111_0110110000, 0b0_00111_0111000000, 0b0_00111_0111010000, 0b0_00111_0111100000, 0b0_00111_0111110000, 
    0b0_00111_1000000000, 0b0_00111_1000010000, 0b0_00111_1000100000, 0b0_00111_1000110000, 0b0_00111_1001000000, 0b0_00111_1001010000, 0b0_00111_1001100000, 0b0_00111_1001110000, 0b0_00111_1010000000, 0b0_00111_1010010000, 0b0_00111_1010100000, 0b0_00111_1010110000, 0b0_00111_1011000000, 0b0_00111_1011010000, 0b0_00111_1011100000, 0b0_00111_1011110000, 
    0b0_00111_1100000000, 0b0_00111_1100010000, 0b0_00111_1100100000, 0b0_00111_1100110000, 0b0_00111_1101000000, 0b0_00111_1101010000, 0b0_00111_1101100000, 0b0_00111_1101110000, 0b0_00111_1110000000, 0b0_00111_1110010000, 0b0_00111_1110100000, 0b0_00111_1110110000, 0b0_00111_1111000000, 0b0_00111_1111010000, 0b0_00111_1111100000, 0b0_00111_1111110000, 
    0b0_01000_0000000000, 0b0_01000_0000010000, 0b0_01000_0000100000, 0b0_01000_0000110000, 0b0_01000_0001000000, 0b0_01000_0001010000, 0b0_01000_0001100000, 0b0_01000_0001110000, 0b0_01000_0010000000, 0b0_01000_0010010000, 0b0_01000_0010100000, 0b0_01000_0010110000, 0b0_01000_0011000000, 0b0_01000_0011010000, 0b0_01000_0011100000, 0b0_01000_0011110000, 
    0b0_01000_0100000000, 0b0_01000_0100010000, 0b0_01000_0100100000, 0b0_01000_0100110000, 0b0_01000_0101000000, 0b0_01000_0101010000, 0b0_01000_0101100000, 0b0_01000_0101110000, 0b0_01000_0110000000, 0b0_01000_0110010000, 0b0_01000_0110100000, 0b0_01000_0110110000, 0b0_01000_0111000000, 0b0_01000_0111010000, 0b0_01000_0111100000, 0b0_01000_0111110000, 
    0b0_01000_1000000000, 0b0_01000_1000010000, 0b0_01000_1000100000, 0b0_01000_1000110000, 0b0_01000_1001000000, 0b0_01000_1001010000, 0b0_01000_1001100000, 0b0_01000_1001110000, 0b0_01000_1010000000, 0b0_01000_1010010000, 0b0_01000_1010100000, 0b0_01000_1010110000, 0b0_01000_1011000000, 0b0_01000_1011010000, 0b0_01000_1011100000, 0b0_01000_1011110000, 
    0b0_01000_1100000000, 0b0_01000_1100010000, 0b0_01000_1100100000, 0b0_01000_1100110000, 0b0_01000_1101000000, 0b0_01000_1101010000, 0b0_01000_1101100000, 0b0_01000_1101110000, 0b0_01000_1110000000, 0b0_01000_1110010000, 0b0_01000_1110100000, 0b0_01000_1110110000, 0b0_01000_1111000000, 0b0_01000_1111010000, 0b0_01000_1111100000, 0b0_01000_1111110000, 
    0b0_01001_0000000000, 0b0_01001_0000010000, 0b0_01001_0000100000, 0b0_01001_0000110000, 0b0_01001_0001000000, 0b0_01001_0001010000, 0b0_01001_0001100000, 0b0_01001_0001110000, 0b0_01001_0010000000, 0b0_01001_0010010000, 0b0_01001_0010100000, 0b0_01001_0010110000, 0b0_01001_0011000000, 0b0_01001_0011010000, 0b0_01001_0011100000, 0b0_01001_0011110000, 
    0b0_01001_0100000000, 0b0_01001_0100010000, 0b0_01001_0100100000, 0b0_01001_0100110000, 0b0_01001_0101000000, 0b0_01001_0101010000, 0b0_01001_0101100000, 0b0_01001_0101110000, 0b0_01001_0110000000, 0b0_01001_0110010000, 0b0_01001_0110100000, 0b0_01001_0110110000, 0b0_01001_0111000000, 0b0_01001_0111010000, 0b0_01001_0111100000, 0b0_01001_0111110000, 
    0b0_01001_1000000000, 0b0_01001_1000010000, 0b0_01001_1000100000, 0b0_01001_1000110000, 0b0_01001_1001000000, 0b0_01001_1001010000, 0b0_01001_1001100000, 0b0_01001_1001110000, 0b0_01001_1010000000, 0b0_01001_1010010000, 0b0_01001_1010100000, 0b0_01001_1010110000, 0b0_01001_1011000000, 0b0_01001_1011010000, 0b0_01001_1011100000, 0b0_01001_1011110000, 
    0b0_01001_1100000000, 0b0_01001_1100010000, 0b0_01001_1100100000, 0b0_01001_1100110000, 0b0_01001_1101000000, 0b0_01001_1101010000, 0b0_01001_1101100000, 0b0_01001_1101110000, 0b0_01001_1110000000, 0b0_01001_1110010000, 0b0_01001_1110100000, 0b0_01001_1110110000, 0b0_01001_1111000000, 0b0_01001_1111010000, 0b0_01001_1111100000, 0b0_01001_1111110000, 
    0b0_01010_0000000000, 0b0_01010_0000010000, 0b0_01010_0000100000, 0b0_01010_0000110000, 0b0_01010_0001000000, 0b0_01010_0001010000, 0b0_01010_0001100000, 0b0_01010_0001110000, 0b0_01010_0010000000, 0b0_01010_0010010000, 0b0_01010_0010100000, 0b0_01010_0010110000, 0b0_01010_0011000000, 0b0_01010_0011010000, 0b0_01010_0011100000, 0b0_01010_0011110000, 
    0b0_01010_0100000000, 0b0_01010_0100010000, 0b0_01010_0100100000, 0b0_01010_0100110000, 0b0_01010_0101000000, 0b0_01010_0101010000, 0b0_01010_0101100000, 0b0_01010_0101110000, 0b0_01010_0110000000, 0b0_01010_0110010000, 0b0_01010_0110100000, 0b0_01010_0110110000, 0b0_01010_0111000000, 0b0_01010_0111010000, 0b0_01010_0111100000, 0b0_01010_0111110000, 
    0b0_01010_1000000000, 0b0_01010_1000010000, 0b0_01010_1000100000, 0b0_01010_1000110000, 0b0_01010_1001000000, 0b0_01010_1001010000, 0b0_01010_1001100000, 0b0_01010_1001110000, 0b0_01010_1010000000, 0b0_01010_1010010000, 0b0_01010_1010100000, 0b0_01010_1010110000, 0b0_01010_1011000000, 0b0_01010_1011010000, 0b0_01010_1011100000, 0b0_01010_1011110000, 
    0b0_01010_1100000000, 0b0_01010_1100010000, 0b0_01010_1100100000, 0b0_01010_1100110000, 0b0_01010_1101000000, 0b0_01010_1101010000, 0b0_01010_1101100000, 0b0_01010_1101110000, 0b0_01010_1110000000, 0b0_01010_1110010000, 0b0_01010_1110100000, 0b0_01010_1110110000, 0b0_01010_1111000000, 0b0_01010_1111010000, 0b0_01010_1111100000, 0b0_01010_1111110000, 
], dtype=torch.int16)
# torch does not have torch.uint16 (x_x)
HF10_TO_FP16 = HF10_TO_FP16.view((2,-1))
HF10_TO_FP16[1,:].bitwise_or_(0x8000)
HF10_TO_FP16 = HF10_TO_FP16.view((-1,))

EXP_MASK = torch.tensor([
    0b1100_0000,
    0b0011_0000,
    0b0000_1100,
    0b0000_0011,
], dtype=torch.uint8)

EXP_SHIFT = torch.tensor([
    2, 4, 6, 8,
], dtype=torch.uint8)

def hf10_to_fp16(exp: torch.Tensor, frac: torch.Tensor):
    global HF10_TO_FP16, EXP_MASK, EXP_SHIFT
    
    assert exp.dtype == torch.uint8
    assert frac.dtype == torch.uint8
    assert exp.ndim == 1
    assert frac.ndim == 1
    assert exp.size(0) * 4 == frac.size(0)

    if HF10_TO_FP16.device != exp.device:
        HF10_TO_FP16 = HF10_TO_FP16.to(exp.device)
    if EXP_MASK.device != exp.device:
        EXP_MASK = EXP_MASK.to(exp.device)
    if EXP_SHIFT.device != exp.device:
        EXP_SHIFT = EXP_SHIFT.to(exp.device)
    
    exp = exp.repeat_interleave(4).view((-1,4))
    exp.bitwise_and_(EXP_MASK)
    indices = exp.to(dtype=torch.int16)
    indices.bitwise_left_shift_(EXP_SHIFT)
    indices = indices.view((-1,))
    indices.add_(frac)
    
    FP16 = torch.take(HF10_TO_FP16, indices.long())
    
    return FP16.view(dtype=torch.float16)
